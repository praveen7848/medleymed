var glob = require('glob');
var fs = require('fs');

function glamourImports(root, glamourFile, importsArray, importedPackages, masterRoot)
{
    (function (undefined)
    {

        if (masterRoot === undefined) masterRoot = root;

        for (var i in glamourFile) {
            var val = glamourFile[i][1];
            switch (glamourFile[i][0]) {
                case 'npm':
                    if (importedPackages.npm.indexOf(val) == -1) {
                        depend(root + '/node_modules/' + val);
                        importedPackages.npm.push(val);
                    }
                    break;
                case 'bower':
                    if (importedPackages.bower.indexOf(val) == -1) {
                        depend(masterRoot + '/bower_components/' + val);
                        importedPackages.bower.push(val);
                    }
                    break;
                case 'npmFile':
                case 'npmFiles':
                case 'npmGlob':
                    imports(root + '/node_modules/' + val);
                    break;
                case 'bowerFile':
                case 'bowerFiles':
                case 'bowerGlob':
                    imports(masterRoot + '/bower_components/' + val);
                    break;
                case 'file':
                case 'files':
                case 'glob':
                    imports(root + '/' + val);
                    break;
                case 'src':
                    imports(root + '/' + val + '/**/!(_)*.s[ca]ss');
                    break;
            }
        }

        function imports(globPattern)
        {
            var newItems = glob.sync(globPattern);
            for (var index in newItems) {
                if (importsArray.indexOf(newItems[index]) == -1) {
                    importsArray = importsArray.concat(newItems[index]);
                }
            }
        }

        function depend(root)
        {
            if (!fs.existsSync(root + '/glamour.json')) {
                return;
            }
            importsArray = glamourImports(
                root,
                require(root + '/glamour.json'),
                importsArray,
                importedPackages,
                masterRoot
            );
        }

    })();
    return importsArray;
}

module.exports = glamourImports;